<!DOCTYPE html>
<html>
  <head>
      <title>Line Simplification Demonstration</title>

      <!-- Add latest Mapbox GL JS and Turf.js libraries -->
      <link href='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css' rel='stylesheet' />
      <script src='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js'></script>
      <script src='https://api.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js'></script>
  </head>
  <body>
    <h1>Line Simplification Demo</h1>
    <!-- Create section for map -->
    <div id="mapid" style="width: 1000px; height: 600px; position: relative;" ></div> <br>
    <h2>About</h2>
    <p>Demonstration of line simplifcation. Draw a polyline on the map and press submit to simplify it.</p>

    <script>
      mapboxgl.accessToken = 'pk.eyJ1Ijoiam9zaGMxOTEiLCJhIjoiY2ttNXNtcXBoMGhhajJucHIzazlyaTdqZyJ9.Jbdqu_PcXM3CdFB2PLFXDQ';
      var map = new mapboxgl.Map({
        container: 'mapid', // container id
        style: 'mapbox://styles/mapbox/light-v10', // stylesheet location
        center: [-114.0719,51.0447], // starting position
        zoom: 12 // starting zoom
      });

      // Add clinics and schools layers to map
      map.on('load', function() {
        map.addLayer({
          id: 'hospitals',
          type: 'symbol',
          source: {
            type: 'geojson',
            data: map_data[0]
          },
          layout: {
            'icon-image': 'hospital-15',
            'icon-allow-overlap': true
          },
          paint: { }
        });
        map.addLayer({
          id: 'schools',
          type: 'symbol',
          source: {
            type: 'geojson',
            data: map_data[1]
          },
          layout: {
            'icon-image': 'school-15'
          },
          paint: { }
        });
      });

      // Add popups
      var popup = new mapboxgl.Popup();

      map.on('mousemove', function(e) {
        var features = map.queryRenderedFeatures(e.point, { layers: ['schools', 'hospitals'] });

        if (!features.length) {
          popup.remove();
          return;
        }
        var feature = features[0];

        popup.setLngLat(feature.geometry.coordinates)
          .setHTML(feature.properties.name)
          .addTo(map);

        map.getCanvas().style.cursor = features.length ? 'pointer' : '';
      });

      // Create source for nearest hospital
      map.addSource('nearest-hospital', {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: [
          ]
        }
      });

      map.on('click', function(e) {
        // Return any features from the 'school' layer whenever the map is clicked
        var schoolFeatures = map.queryRenderedFeatures(e.point, { layers: ['schools'] });
        if (!schoolFeatures.length) {
          return;
        }
        var schoolFeature = schoolFeatures[0];

        // Using Turf, find the nearest hospital to library clicked
        var nearestHospital = turf.nearest(schoolFeature, map_data[0]);

        // If a nearest library is found
        if (nearestHospital !== null) {
          // Update the 'nearest-library' data source to include
          // the nearest library
          map.getSource('nearest-hospital').setData({
            type: 'FeatureCollection',
            features: [
              nearestHospital
            ]
          });
          // Create a new circle layer from the 'nearest-library' data source
          map.addLayer({
            id: 'nearest-hospital',
            type: 'circle',
            source: 'nearest-hospital',
            paint: {
              'circle-radius': 12,
              'circle-color': '#486DE0'
            }
          }, 'hospitals');
        }
      });


    </script>
  </body>
</html>
